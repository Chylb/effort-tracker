<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <div th:replace="fragments/head ::head"></div>
    <title>Distance</title>

    <style>
        .container {
            padding-bottom: 50px;
        }
    </style>
</head>
<body>

<div th:replace="fragments/navbar ::navbar"></div>


<div class="container">
    <h1 class="float-left" id="distance">Distance </h1>

    <!-- Button trigger modal -->
    <button type="button" class="btn btn-secondary float-right" data-toggle="modal" data-target="#exampleModal">
        Delete
    </button>
</div>

<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-body">
                Are you sure you want to delete this distance?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="submit" class="btn btn-primary" onclick="deleteDistance()">Yes</button>
            </div>
        </div>
        <div id="alert" class="alert text-center" role="alert" style="display: none"></div>
    </div>
</div>
</br>

<div class="container">
    <h2>All time best efforts</h2>
    </br>
    <canvas id="canvas_alltime" height="125px"></canvas>
</div>
</br>
<div class="container">
    <h2>Season best efforts</h2>
    </br>
    <canvas id="canvas_season" height="125px"></canvas>
</div>

<div class="container" id="tableContainer">
    <h2>All efforts</h2>
    </br>
    <table class="table table-striped" id="effortTable">
        <thead>
        <tr>
            <th scope="col">Activity</th>
            <th scope="col">Date</th>
            <th scope="col">Time</th>
            <th scope="col">Pace</th>
        </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>

<script>
    $("#navDistances").addClass("active");
    const ID = window.location.href.split("/").pop();

    const ctx_alltime = document.getElementById('canvas_alltime').getContext('2d');
    const cfg_alltime = generateConfig();
    const chart_alltime = new Chart(ctx_alltime, cfg_alltime);
    document.getElementById("canvas_alltime").onclick = function (evt) {
        const item = chart_alltime.getElementsAtXAxis(evt)[0];
        const id = chart_alltime.getElementsAtXAxis(evt)[0]._chart.chart.config.data.datasets[0].data[item._index].id;
        window.location.href = "/activity/" + id;
    };

    const ctx_season = document.getElementById('canvas_season').getContext('2d');
    const cfg_season = generateConfig();
    const chart_season = new Chart(ctx_season, cfg_season);
    document.getElementById("canvas_season").onclick = function (evt) {
        const item = chart_season.getElementsAtXAxis(evt)[0];
        const id = chart_season.getElementsAtXAxis(evt)[0]._chart.chart.config.data.datasets[0].data[item._index].id;
        window.location.href = "/activity/" + id;
    };

    $.getJSON("/api/distances/" + ID, function (data) {
        $("#distance").text( "Distance " + data.name);
    }).fail(function (){window.location.href = "/error"});

    $.getJSON("/api/distances/" + ID + "/allTimeBest", function (data) {
        const chartData = [];
        for (x of data) {
            const row = {
                x: new Date(x.activity.date).getFullYear(),
                y: x.time,
                id: x.activity.id,
                date: new Date(x.activity.date).toISOString().split("T")[0],
                name: x.activity.name
            };
            chartData.push(row);
        }

        chart_alltime.config.data.datasets[0].data = chartData;
        chart_alltime.update();
    });

    $.getJSON("/api/distances/" + ID + "/seasonBest?year=2020", function (data) {
        const chartData = [];
        for (x of data) {
            const row = {
                x: new Date(x.activity.date).getMonth() + 1,
                y: x.time,
                id: x.activity.id,
                date: new Date(x.activity.date).toISOString().split("T")[0],
                name: x.activity.name
            };
            chartData.push(row);
        }

        chart_season.config.data.datasets[0].data = chartData;
        chart_season.update();
    });

    $.getJSON("/api/distances/" + ID + "/efforts", function (data) {
        populateTable(data);
    });

    function deleteDistance() {
        $.ajax({
            type: "DELETE",
            url: "/api/distances/" + ID,
            success: function (x) {
                window.location.href = "/distances"
            }
        });
    }

    function generateConfig() {
        return {
            data: {
                datasets: [{
                    label: 'Time',
                    backgroundColor: "#00aaff",
                    borderColor: "#00aaff",
                    data: [],
                    type: 'line',
                    pointRadius: 3,
                    fill: false,
                    lineTension: 0,
                    borderWidth: 2
                }]
            },
            options: {
                animation: {
                    duration: 0
                },
                legend: {
                    display: false
                },
                scales: {
                    xAxes: [{
                        type: 'linear',
                        ticks: {
                            stepSize: 1
                        }
                    }],
                    yAxes: [{
                        gridLines: {
                            drawBorder: false
                        },
                        scaleLabel: {
                            display: true,
                            labelString: 'Time'
                        },
                        ticks: {
                            reverse: true
                        }
                    }]
                },
                tooltips: {
                    displayColors: false,
                    intersect: false,
                    mode: 'index',
                    callbacks: {
                        label: (tooltipItem, data) => {
                            return ["Time: " + secondsToString(tooltipItem.value),
                                "Date: " + data.datasets[0].data[tooltipItem.index].date,
                                "Activity: " + data.datasets[0].data[tooltipItem.index].name
                            ];
                        }
                    }
                }
            }
        }
    }

    function populateTable(data) {
        const table = $('#effortTable')
        for (const e of data) {
            const date = new Date(e.activity.date);
            const row = `<tr>
                  <td><a href="/activity/${e.activity.id}">${e.activity.name}</a></td>
                  <td>${date.toLocaleString('en-GB')}</td>
                  <td>${secondsToString(e.time)}</td>
                  <td>${secondsToString(e.time / e.distance.length * 1000)}</td>
                  `
            table.append(row);
        }
    }
</script>

<div th:replace="fragments/footer ::footer"></div>

</body>
</html>